<!DOCTYPE html>
<html lang="en" id="top" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Booked — Our Reading Journey</title>
<meta name="description" content="Booked: our book club's reads since 2023." />
<meta name="theme-color" content="#101012" />
<style>
  /* ============== THEME TOKENS ============== */
  :root{
    --radius: 18px;
    --blur: 12px;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --accent: 262 83% 62%;
  }
  /* light palette (default) */
  :root[data-theme="light"]{
    color-scheme: light;
    --bg: #faf9ff;
    --fg: #101012;
    --muted:#4a4a57;
    --card:#ffffff;
    --glass: rgba(0,0,0,.06);
    --shadow: 0 10px 30px rgba(26,26,44,.12);
  }
  /* dark palette */
  :root[data-theme="dark"]{
    color-scheme: dark;
    --bg: #0b0c10;
    --fg: #e7e7ec;
    --muted:#b7b7c7;
    --card:#12131a;
    --glass: rgba(255,255,255,.06);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font: 16px/1.6 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    background: radial-gradient(1400px 900px at 10% -10%, hsl(210 80% 55%/.10), transparent 55%),
                radial-gradient(1200px 800px at 110% -10%, hsl(300 80% 55%/.08), transparent 50%),
                radial-gradient(800px 600px at 50% 120%, hsl(160 90% 50%/.09), transparent 50%),
                var(--bg);
    color:var(--fg);
    overflow-x:hidden;
  }

  /* ============== HERO ============== */
  header.hero{
    position:relative;
    min-height:70svh;
    display:grid;
    place-items:center;
    padding: clamp(24px,4vw,48px);
    text-align:center;
    isolation:isolate;
  }
  header.hero .back-blur{
    position:absolute; inset:-20vmax;
    filter: blur(110px);
    background:
      radial-gradient(closest-side, hsl(260 80% 60%/.50), transparent) 15% 25%/40% 40% no-repeat,
      radial-gradient(closest-side, hsl(190 90% 55%/.55), transparent) 80% 30%/30% 30% no-repeat,
      radial-gradient(closest-side, hsl(120 75% 55%/.45), transparent) 60% 80%/35% 35% no-repeat;
    z-index:-1;
    opacity:.75;
    animation: floaty 18s linear infinite alternate;
  }
  @keyframes floaty{ to{ transform: translate3d(0,-2%,0) rotate(.5deg); filter: blur(120px); } }

  .badge{
    display:inline-block;
    padding:.35rem .7rem;
    border-radius:999px;
    background: hsl(var(--accent)/.15);
    color: hsl(var(--accent));
    font-weight:600;
    letter-spacing:.03em;
    border:1px solid hsl(var(--accent)/.25);
    backdrop-filter: blur(6px);
  }
  h1{
    font-size: clamp(38px, 6vw, 82px);
    line-height:1.05;
    margin:.7rem 0;
    letter-spacing:-.015em;
  }
  .sub{
    max-width: 64ch;
    margin: 0 auto 1.25rem;
    color:var(--muted);
    font-size: clamp(16px, 2.2vw, 20px);
  }

  .controls{
    display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    margin-top: 1rem;
  }
  .pill{
    display:inline-flex; align-items:center; gap:.55rem;
    border:1px solid color-mix(in oklab, var(--fg) 10%, transparent);
    border-radius:999px; padding:.55rem .9rem; background:var(--glass);
    backdrop-filter: blur(8px);
    box-shadow: var(--shadow);
  }
  input[type="search"]{ all:unset; padding:.25rem; min-width: min(60vw, 320px); }
  button, .chip{
    all: unset; cursor:pointer;
    display:inline-flex; align-items:center; gap:.5rem;
    padding:.55rem .9rem; border-radius:999px; font-weight:600;
    border:1px solid color-mix(in oklab, var(--fg) 10%, transparent);
    background: var(--glass);
  }
  .chip[data-active="true"]{ background:hsl(var(--accent)/.18); border-color:hsl(var(--accent)/.35); color:hsl(var(--accent)); }
  .theme-toggle{ transition: transform .2s ease; }
  .theme-toggle:active{ transform: scale(.96); }

  /* sticky year headers */
  .year{
    position:sticky; top:0; z-index:5;
    backdrop-filter: blur(10px);
    background: color-mix(in oklab, var(--bg), transparent 25%);
    margin: 0; padding: .45rem 1.25rem;
    font-size: clamp(22px,3.4vw,34px); letter-spacing:.02em;
    border-bottom:1px solid color-mix(in oklab, var(--fg) 12%, transparent);
  }

  main{ padding: 32px clamp(18px, 5vw, 56px) 120px; }
  .grid{
    display:grid; gap: clamp(14px, 2vw, 24px);
    grid-template-columns: repeat(auto-fill, minmax(min(230px, 100%), 1fr));
  }

  /* ============== BOOK CARD ============== */
  a.book{
    color:inherit; text-decoration:none;
  }
  .book{
    position:relative; overflow:hidden; border-radius: var(--radius);
    background: linear-gradient(180deg, color-mix(in oklab, var(--card), transparent 8%), color-mix(in oklab, var(--card), transparent 0%));
    border: 1px solid color-mix(in oklab, var(--fg) 10%, transparent);
    box-shadow: var(--shadow);
    transform-style: preserve-3d;
    transition: transform .25s ease, border-color .25s ease, box-shadow .25s ease;
  }
  .book:hover{ transform: translateY(-4px) rotateX(.6deg) rotateY(.6deg); border-color: hsl(var(--accent)/.35); box-shadow: 0 16px 40px rgba(0,0,0,.25); }

  /* cover: unique, subtly animated gradient + optional real image */
  .cover{
    height: 260px; border-bottom:1px solid color-mix(in oklab, var(--fg) 12%, transparent);
    position:relative; overflow:hidden;
    background:
      radial-gradient(110px 110px at 12% 18%, hsl(var(--h) 82% 62% / .75), transparent 70%),
      radial-gradient(150px 120px at 88% 22%, hsl(calc(var(--h) + 40) 82% 62% / .7), transparent 70%),
      radial-gradient(140px 140px at 30% 88%, hsl(calc(var(--h) + 80) 80% 60% /.65), transparent 70%),
      linear-gradient(135deg, hsl(calc(var(--h) + 12) 42% 16%), hsl(calc(var(--h) - 8) 42% 10%));
    animation: hueWander 18s linear infinite;
    background-size: cover;
    background-blend-mode: normal;
  }
  @keyframes hueWander{ 50%{ filter: hue-rotate(18deg) saturate(1.05);} }

  /* real cover overlay (fades in) */
  .cover.has-img{ background-size: cover; background-position: center; }
  .cover::after{
    content:""; position:absolute; inset:-20%;
    background:
      radial-gradient(closest-side, #fff2, transparent) 20% 20%/30% 30% no-repeat,
      radial-gradient(closest-side, #fff3, transparent) 80% 25%/26% 26% no-repeat,
      radial-gradient(closest-side, #fff1, transparent) 50% 75%/50% 40% no-repeat;
    mix-blend-mode: overlay; filter: blur(4px); transform: rotate(8deg);
    pointer-events:none;
  }
  /* skeleton shimmer while fetching */
  .cover.skeleton::before{
    content:""; position:absolute; inset:0;
    background: linear-gradient(90deg, #fff0, #fff3, #fff0);
    animation: shimmer 1.6s infinite;
    mix-blend-mode: soft-light;
  }
  @keyframes shimmer{ 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }

  .corner{
    position:absolute; top:10px; left:10px; font-size: 12px; font-weight:700;
    padding:.25rem .5rem; border-radius: 999px; background: hsl(var(--accent)/.2); color:hsl(var(--accent));
    border:1px solid hsl(var(--accent)/.35);
  }

  .info{ padding: 14px 16px 16px; }
  .title{ margin:0 0 .15rem; font-weight:700; letter-spacing:.01em; font-size: 18px; }
  .author{ margin:0 0 .6rem; color:var(--muted); font-size: 13px; }
  .meta{ display:flex; align-items:center; justify-content:space-between; gap:8px; color:var(--muted); font-size:13px; }
  .tag{
    border:1px solid color-mix(in oklab, var(--fg) 10%, transparent);
    padding:.25rem .5rem; border-radius:999px; backdrop-filter: blur(6px); background:var(--glass);
  }

  /* reveal on scroll */
  .reveal{ opacity:0; transform: translateY(10px) scale(.98); }
  .reveal.in{ opacity:1; transform:none; transition: transform .6s cubic-bezier(.2,.8,.2,1), opacity .6s ease; }

  /* top button */
  .top{
    position:fixed; right:16px; bottom:16px; z-index:50;
    border-radius: 999px; padding:.75rem 1rem; border:1px solid color-mix(in oklab, var(--fg) 10%, transparent);
    background: var(--glass); backdrop-filter: blur(10px); box-shadow: var(--shadow);
    text-decoration:none; color:inherit;
  }

  footer{ padding: 48px 24px 72px; text-align:center; color:var(--muted); }

  :focus-visible{ outline: 2px solid hsl(var(--accent)); outline-offset:3px; border-radius:6px; }
  ::selection{ background:hsl(var(--accent)/.3); color:var(--fg); }
 
  /* ——— Stats ——— */
#stats{ padding: 24px clamp(18px,5vw,56px) 120px; }
.stats-grid{
  display:grid; gap: clamp(14px, 2vw, 24px);
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
}
.stat-card{
  border:1px solid color-mix(in oklab, var(--fg) 10%, transparent);
  border-radius: var(--radius);
  background: var(--card);
  box-shadow: var(--shadow);
  padding:16px;
}
.stat-card h3{ margin:0 0 8px; font-size:16px; letter-spacing:.02em; }
.stat-pill{
  display:inline-block; padding:.25rem .5rem; border-radius:999px;
  border:1px solid color-mix(in oklab, var(--fg) 10%, transparent);
  background:var(--glass); margin:.125rem; font-size:12px;
}
</style>
</head>
<body>
<header class="hero">
  <div class="back-blur" aria-hidden="true"></div>
  <div>
    <span class="badge">Booked · book club</span>
    <h1>Our Reading Journey</h1>
    <p class="sub">Every book we’ve read since we began. Filter, search, and toggle themes.</p>

    <div class="controls" role="group" aria-label="Filters">
      <label class="pill" title="Search books">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.3-4.3m2.1-5.2a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="search" type="search" placeholder="Search title, author, or month…" />
      </label>

      <div class="pill" style="gap:6px;" title="Filter by year">
        <span>Year:</span>
        <button class="chip" data-year="all" data-active="true">All</button>
        <button class="chip" data-year="2023">2023</button>
        <button class="chip" data-year="2024">2024</button>
        <button class="chip" data-year="2025">2025</button>
      </div>
      <button class="pill" id="statsToggle" title="Show stats">📈 Stats</button>


      <button class="pill theme-toggle" id="themeBtn" title="Toggle light/dark">
        <svg id="sun" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="display:none;"><path d="M12 4V2m0 20v-2M4 12H2m20 0h-2M5 5L3.5 3.5M20.5 20.5L19 19M19 5l1.5-1.5M3.5 20.5L5 19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="2"/></svg>
        <svg id="moon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 15.5A8.5 8.5 0 119.5 4a7 7 0 0010.5 11.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <span>Theme</span>
      </button>
    </div>
  </div>
</header>

<main id="content" aria-live="polite"></main>

<section id="stats" hidden>
  <h2 class="year" style="position:static">Stats</h2>
  <div class="stats-grid">
    <div class="stat-card">
      <h3>Total books</h3>
      <p id="totalBooks">—</p>
      <div id="byLang" style="margin-top:.5rem;"></div>
    </div>

    <div class="stat-card">
      <h3>By year</h3>
      <canvas id="chartByYear" height="220"></canvas>
    </div>

    <div class="stat-card">
      <h3>By author country</h3>
      <canvas id="chartByCountry" height="240"></canvas>
    </div>

    <div class="stat-card">
      <h3>Pages: total / avg / median</h3>
      <p id="pagesSummary">Fetching page counts…</p>
      <canvas id="chartPages" height="240"></canvas>
    </div>

    <div class="stat-card">
      <h3>Longest & shortest (by pages)</h3>
      <ul id="extremes" style="padding-left:18px;margin:6px 0 0;"></ul>
    </div>
  </div>

  <p class="sub" style="text-align:center;margin-top:24px;color:var(--muted)">
    Notes: Country = author nationality (editable map). Page counts come from Open Library (cached locally).
  </p>
</section>


<a class="top" href="#top" id="toTop" title="Back to top" style="display:none">↑ Top</a>

<footer>
  Built with ♥ for <strong>Booked</strong>.
</footer>

<script>
/* ====================== DATA (added authors) ====================== */
const BOOKS = [
  // 2023
  {year:2023, month:"November", title:"The Wall", author:"Marlen Haushofer"},
  {year:2023, month:"December", title:"Giovanni's Room", author:"James Baldwin"},
  // 2024
  {year:2024, month:"January", title:"After Dark", author:"Haruki Murakami"},
  {year:2024, month:"February", title:"Orlando", author:"Virginia Woolf"},
  {year:2024, month:"March", title:"The Lathe of Heaven", author:"Ursula K. Le Guin"},
  {year:2024, month:"April", title:"Death with Interruptions", author:"José Saramago"},
  {year:2024, month:"May", title:"An Apprenticeship or The Book of Pleasures", author:"Clarice Lispector"},
  {year:2024, month:"June", title:"Lolita", author:"Vladimir Nabokov"},
  {year:2024, month:"July", title:"Of Love and Other Demons", author:"Gabriel García Márquez"},
  {year:2024, month:"August", title:"Notes from Underground", author:"Fyodor Dostoevsky"},
  {year:2024, month:"September", title:"Lapvona", author:"Ottessa Moshfegh"},
  {year:2024, month:"October", title:"The Picture of Dorian Gray", author:"Oscar Wilde"},
  {year:2024, month:"November", title:"Dracula", author:"Bram Stoker"},
  {year:2024, month:"December", title:"White Nights", author:"Fyodor Dostoevsky"},
  // 2025
  {year:2025, month:"January", title:"Moby-Dick", author:"Herman Melville"},
  {year:2025, month:"February", title:"One Hundred Years of Solitude", author:"Gabriel García Márquez"},
  {year:2025, month:"March", title:"Fahrenheit 451", author:"Ray Bradbury"},
  {year:2025, month:"May", title:"Invisible Cities", author:"Italo Calvino"},
  {year:2025, month:"June", title:"A Room of One's Own", author:"Virginia Woolf"},
  {year:2025, month:"July", title:"Animal Farm", author:"George Orwell"},
  {year:2025, month:"August", title:"Strange Case of Dr Jekyll and Mr Hyde", author:"Robert Louis Stevenson"}
];

/* ====================== HELPERS ====================== */
const $ = (sel, ctx=document)=>ctx.querySelector(sel);
const $$ = (sel, ctx=document)=>Array.from(ctx.querySelectorAll(sel));

function hashHue(str){
  let h=0; for (let i=0;i<str.length;i++){ h = (h*31 + str.charCodeAt(i)) >>> 0; } return h % 360;
}

/* ====================== RENDER ====================== */
function createCard(item, index){
  const h = hashHue(item.title + item.month + item.year + item.author);
  const link = document.createElement('a');
  link.className = 'book reveal';
  link.setAttribute('tabindex','0');
  link.dataset.year = item.year;
  link.dataset.month = item.month.toLowerCase();
  link.dataset.title = item.title.toLowerCase();
  link.dataset.author = item.author.toLowerCase();
  link.href = '#'; // temporary, will be upgraded to Open Library link if found
  link.target = '_blank'; link.rel = 'noopener noreferrer';

  link.innerHTML = `
    <div class="cover skeleton" style="--h:${h}">
      <span class="corner">${item.year}</span>
    </div>
    <div class="info">
      <h3 class="title">${item.title}</h3>
      <p class="author">${item.author}</p>
      <div class="meta">
        <span class="tag" title="Month">${item.month}</span>
        <span class="tag" title="Index in list">#${index+1}</span>
      </div>
    </div>
  `;

  // tilt
  link.addEventListener('pointermove', (e)=>{
    const r = link.getBoundingClientRect();
    const x = (e.clientX - r.left) / r.width;
    const y = (e.clientY - r.top) / r.height;
    const rx = (y - .5) * -6;
    const ry = (x - .5) * 6;
    link.style.transform = `perspective(800px) rotateX(${rx}deg) rotateY(${ry}deg) translateY(-2px)`;
  });
  link.addEventListener('pointerleave', ()=>{ link.style.transform = ''; });

  return link;
}

function render(){
  const content = $('#content');
  content.innerHTML = '';

  const years = [...new Set(BOOKS.map(b=>b.year))].sort((a,b)=>a-b);
  years.forEach(Y=>{
    const h2 = document.createElement('h2');
    h2.className='year';
    h2.textContent = Y;
    content.appendChild(h2);

    const grid = document.createElement('section');
    grid.className='grid';
    grid.setAttribute('aria-label', `Books read in ${Y}`);

    BOOKS.filter(b=>b.year===Y).forEach((b,i)=>{
      grid.appendChild(createCard(b, BOOKS.indexOf(b)));
    });

    content.appendChild(grid);
  });

  // reveal on scroll
  const io = new IntersectionObserver((entries)=>entries.forEach(en=>{
    if (en.isIntersecting) en.target.classList.add('in');
  }), {threshold: .12});
  $$('.reveal', content).forEach(el=> io.observe(el));
}

/* ====================== FILTERS ====================== */
function applyFilters(){
  const q = $('#search').value.trim().toLowerCase();
  const activeChip = $('.chip[data-active="true"]');
  const yearFilter = activeChip?.dataset.year ?? 'all';

  $$('.grid .book').forEach(card=>{
    const okYear = (yearFilter==='all') || (String(card.dataset.year)===yearFilter);
    const blob = (card.dataset.title + ' ' + card.dataset.month + ' ' + card.dataset.author);
    const okText = q==='' || blob.includes(q);
    card.style.display = (okYear && okText) ? '' : 'none';
  });
}

/* ====================== THEME ====================== */
function setTheme(mode){
  document.documentElement.dataset.theme = mode;
  localStorage.setItem('theme', mode);
  // icon swap
  const dark = mode==='dark';
  $('#moon').style.display = dark ? 'block':'none';
  $('#sun').style.display  = dark ? 'none' :'block';
}
function initTheme(){
  const saved = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  setTheme(saved ?? (prefersDark ? 'dark' : 'light'));
}

/* ====================== BACK TO TOP ====================== */
function setupTopButton(){
  const btn = $('#toTop');
  const show = () => { btn.style.display = (window.scrollY>500) ? 'inline-flex' : 'none'; };
  window.addEventListener('scroll', show, {passive:true});
  show();
}

/* ====================== COVERS (Open Library) ====================== */
async function fetchCover({title, author}){
  const url = `https://openlibrary.org/search.json?title=${encodeURIComponent(title)}&author=${encodeURIComponent(author)}&limit=5`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('search failed');
  const data = await r.json();
  const doc = (data.docs || [])
    .filter(d => d.cover_i)
    .sort((a,b)=>(b.edition_count||0)-(a.edition_count||0))[0];
  if(!doc) return null;

  const coverUrl = `https://covers.openlibrary.org/b/id/${doc.cover_i}-L.jpg`;
  const workKey = (doc.key && doc.key.startsWith('/works/')) ? doc.key : (doc.work_key && doc.work_key[0]);
  const link = workKey ? `https://openlibrary.org${workKey}` :
                         `https://openlibrary.org/search?q=${encodeURIComponent(title + ' ' + author)}`;
  return {coverUrl, link};
}

async function hydrateCovers(){
  const cards = $$('.grid .book');
  const concurrency = 4;
  let i = 0;
  async function next(){
    if (i >= cards.length) return;
    const idx = i++;
    const el = cards[idx];
    const title = el.dataset.title;
    const author = el.dataset.author;
    try{
      const res = await fetchCover({title, author});
      if (res){
        const cover = el.querySelector('.cover');
        cover.style.backgroundImage = `url("${res.coverUrl}")`;
        cover.classList.add('has-img');
        el.href = res.link;
      }
    }catch(_){}
    finally{
      el.querySelector('.cover')?.classList.remove('skeleton');
      next();
    }
  }
  Array.from({length: Math.min(concurrency, cards.length)}).forEach(next);
}

/* ====================== BOOT ====================== */
document.addEventListener('DOMContentLoaded', ()=>{
  initTheme();
  render();
  setupTopButton();

  // Search
  $('#search').addEventListener('input', applyFilters);

  // Year chips
  $$('.chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      $$('.chip').forEach(x=>x.dataset.active='false');
      ch.dataset.active='true';
      applyFilters();
      const Y = ch.dataset.year;
      if (Y!=='all'){
        const target = $$('.year').find(h=>h.textContent.trim()===Y);
        if (target) target.scrollIntoView({behavior:'smooth', block:'start'});
      }
    });
  });

  // Theme toggle
  $('#themeBtn').addEventListener('click', ()=>{
    const cur = document.documentElement.dataset.theme || 'light';
    setTheme(cur === 'dark' ? 'light' : 'dark');
  });

  // animated accent hue
  const updateAccent = ()=>{
    const t = Date.now()/1000;
    const hue = Math.floor((t/20)%360);
    document.documentElement.style.setProperty('--accent', `${hue} 83% 62%`);
    requestAnimationFrame(updateAccent);
  };
  updateAccent();

  // Load real covers & links
  hydrateCovers();
});
</script>

<script>
/* ========= editable: author -> country/lang for nicer grouping ========= */
const AUTHOR_INFO = {
  "Marlen Haushofer":   {country:"Austria",        lang:"German"},
  "James Baldwin":     {country:"USA",       lang:"English"},
  "Haruki Murakami":   {country:"Japan",     lang:"Japanese"},
  "Virginia Woolf":    {country:"UK",        lang:"English"},
  "Ursula K. Le Guin": {country:"USA",       lang:"English"},
  "José Saramago":     {country:"Portugal",  lang:"Portuguese"},
  "Clarice Lispector": {country:"Brazil",    lang:"Portuguese"},
  "Vladimir Nabokov":  {country:"Russia",    lang:"English"},
  "Gabriel García Márquez": {country:"Colombia", lang:"Spanish"},
  "Fyodor Dostoevsky": {country:"Russia",    lang:"Russian"},
  "Ottessa Moshfegh":  {country:"USA",       lang:"English"},
  "Oscar Wilde":       {country:"Ireland",   lang:"English"},
  "Bram Stoker":       {country:"Ireland",   lang:"English"},
  "Herman Melville":   {country:"USA",       lang:"English"},
  "Ray Bradbury":      {country:"USA",       lang:"English"},
  "Italo Calvino":     {country:"Italy",     lang:"Italian"},
  "George Orwell":     {country:"UK",        lang:"English"},
  "Robert Louis Stevenson": {country:"UK",   lang:"English"}
};

/* ========= tiny canvas helpers (no libs) ========= */
function cssVar(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
function accentColor(){ return `hsl(${cssVar('--accent')})`; }

function drawBars(canvas, labels, values, {title='', maxY=null}={}){
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.clientWidth * devicePixelRatio;
  const H = canvas.height = canvas.clientHeight * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);

  const m = {t: 10, r: 12, b: 34, l: 28};
  const w = canvas.clientWidth - m.l - m.r;
  const h = canvas.clientHeight - m.t - m.b;
  const max = maxY ?? Math.max(1, ...values);
  const bw = Math.max(10, w / Math.max(values.length,1) * 0.72);
  const gap = (w - bw*values.length) / Math.max(values.length-1,1);

  // grid
  ctx.strokeStyle = 'rgba(150,150,170,.25)';
  ctx.lineWidth = 1;
  const gridLines = 4;
  for(let i=0;i<=gridLines;i++){
    const y = m.t + h - (h * i / gridLines);
    ctx.beginPath(); ctx.moveTo(m.l, y); ctx.lineTo(m.l + w, y); ctx.stroke();
  }

  // bars
  ctx.fillStyle = accentColor();
  labels.forEach((lab, i)=>{
    const x = m.l + i*(bw+gap);
    const y = m.t + h - (values[i]/max)*h;
    const bh = (values[i]/max)*h;
    ctx.fillRect(x, y, bw, bh);
  });

  // x labels
  ctx.fillStyle = cssVar('--muted') || '#888';
  ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto';
  ctx.textAlign = 'center';
  labels.forEach((lab,i)=>{
    const x = m.l + i*(bw+gap) + bw/2;
    ctx.fillText(String(lab), x, m.t + h + 18);
  });
}

function drawHistogram(canvas, nums, bins=8){
  const vals = nums.filter(n => Number.isFinite(n));
  if (!vals.length){ canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height); return; }
  const min = Math.min(...vals), max = Math.max(...vals);
  const step = Math.max(1, Math.ceil((max-min)/bins));
  const edges = Array.from({length: bins}, (_,i)=>min + i*step);
  const counts = Array.from({length: bins}, ()=>0);
  vals.forEach(v=>{
    let idx = Math.floor((v-min)/step);
    if (idx >= bins) idx = bins-1;
    counts[idx]++;
  });
  const labels = edges.map((e,i)=> (i===bins-1?`${e}+`:`${e}-${e+step-1}`));
  drawBars(canvas, labels, counts, {maxY: Math.max(...counts)});
}

/* ========= Pages lookup via Google Books (primary) + Open Library (fallback) ========= */
const GOOGLE_BOOKS_API_KEY = ""; // Optional: add your Google Books API key (works without one, just lower quota)
const PAGES_CACHE_KEY = 'booked_pages_v2';
const PAGES_OVERRIDE = { /* Manual overrides: "Title|||Author": pages */ };

async function fetchPagesFromGoogleBooks({title, author}){
  const q = `intitle:${title} inauthor:${author}`;
  const params = new URLSearchParams({q, maxResults: "10", printType: "books", fields: "items(volumeInfo/title,volumeInfo/authors,volumeInfo/pageCount)"});
  if (GOOGLE_BOOKS_API_KEY) params.set("key", GOOGLE_BOOKS_API_KEY);
  const r = await fetch(`https://www.googleapis.com/books/v1/volumes?`+params.toString());
  if(!r.ok) throw new Error('gbooks failed');
  const data = await r.json();
  const items = data.items || [];
  const counts = items.map(it => it?.volumeInfo?.pageCount).filter(n => Number.isFinite(n) && n >= 40 && n <= 1600).sort((a,b)=>a-b);
  if (!counts.length) return null;
  return counts[Math.floor((counts.length-1)/2)]; // median
}

async function fetchPagesFromOpenLibrary({title, author}){
  const url = `https://openlibrary.org/search.json?title=${encodeURIComponent(title)}&author=${encodeURIComponent(author)}&limit=5`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('ol failed');
  const data = await r.json();
  const doc = (data.docs||[]).filter(d => d.number_of_pages_median).sort((a,b)=>(b.edition_count||0)-(a.edition_count||0))[0];
  return doc?.number_of_pages_median ?? null;
}

async function getPagesMap(books){
  let cache = {};
  try{ cache = JSON.parse(localStorage.getItem(PAGES_CACHE_KEY) || '{}'); }catch(_){}
  const keys = b => `${b.title}|||${b.author}`;
  for (const b of books){ if (PAGES_OVERRIDE[keys(b)] != null) cache[keys(b)] = PAGES_OVERRIDE[keys(b)]; }
  const pending = books.filter(b => cache[keys(b)] == null);
  const concurrency = 4;
  let i = 0;
  async function next(){
    if (i >= pending.length) return;
    const b = pending[i++];
    const k = keys(b);
    if (cache[k] != null) return next();
    try{
      let pages = await fetchPagesFromGoogleBooks(b);
      if (pages == null) pages = await fetchPagesFromOpenLibrary(b);
      cache[k] = Number.isFinite(pages) ? pages : null;
    }catch(_){ cache[k] = null; }
    finally{ localStorage.setItem(PAGES_CACHE_KEY, JSON.stringify(cache)); }
    return next();
  }
  await Promise.all(Array.from({length: Math.min(concurrency, pending.length)}).map(next));
  return cache;
}

/* ========= Stats builder ========= */
function summarize(books, pagesMap){
  const byYear = {}, byCountry = {}, byLang = {};
  const pages = [];
  books.forEach(b=>{
    byYear[b.year] = (byYear[b.year]||0)+1;
    const info = AUTHOR_INFO[b.author] || {country:'Unknown', lang:'Unknown'};
    byCountry[info.country] = (byCountry[info.country]||0)+1;
    byLang[info.lang] = (byLang[info.lang]||0)+1;
    const pg = pagesMap[`${b.title}|||${b.author}`];
    if (Number.isFinite(pg)) pages.push({title:b.title, author:b.author, pages:pg});
  });
  const total = books.length;
  const pageNums = pages.map(p=>p.pages).sort((a,b)=>a-b);
  const totalPages = pageNums.reduce((a,b)=>a+b,0);
  const avgPages = pageNums.length ? Math.round(totalPages / pageNums.length) : 0;
  const medianPages = pageNums.length ? (pageNums.length%2 ? pageNums[(pageNums.length-1)/2] : Math.round((pageNums[pageNums.length/2-1]+pageNums[pageNums.length/2])/2)) : 0;
  const longest = [...pages].sort((a,b)=>b.pages-a.pages)[0];
  const shortest = [...pages].sort((a,b)=>a.pages-b.pages)[0];
  return {total, byYear, byCountry, byLang, pages:pageNums, totalPages, avgPages, medianPages, longest, shortest};
}

/* ========= UI wiring ========= */
async function buildStats(){
  $('#totalBooks').textContent = BOOKS.length;
  const langHost = document.getElementById('byLang');
  const langCounts = BOOKS.reduce((acc,b)=>{ const lang = (AUTHOR_INFO[b.author]?.lang) || 'Unknown'; acc[lang] = (acc[lang]||0)+1; return acc; }, {});
  langHost.innerHTML = Object.entries(langCounts).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<span class="stat-pill" title="Language">${k}: ${v}</span>`).join('');
  
  const yearLabels = [...new Set(BOOKS.map(b=>b.year))].sort((a,b)=>a-b);
  const yearValues = yearLabels.map(y => BOOKS.filter(b=>b.year===y).length);
  drawBars(document.getElementById('chartByYear'), yearLabels, yearValues);

  const countryCounts = BOOKS.reduce((acc,b)=>{ const c = (AUTHOR_INFO[b.author]?.country) || 'Unknown'; acc[c] = (acc[c]||0)+1; return acc; }, {});
  const cEntries = Object.entries(countryCounts).sort((a,b)=>b[1]-a[1]);
  drawBars(document.getElementById('chartByCountry'), cEntries.map(e=>e[0]), cEntries.map(e=>e[1]));

  const pagesMap = await getPagesMap(BOOKS);
  const S = summarize(BOOKS, pagesMap);

  document.getElementById('pagesSummary').textContent = S.pages.length ? `Total: ${S.totalPages.toLocaleString()} · Avg: ${S.avgPages} · Median: ${S.medianPages} (from ${S.pages.length}/${BOOKS.length} books)` : 'No page data yet.';
  drawHistogram(document.getElementById('chartPages'), S.pages, 8);
  const extremes = document.getElementById('extremes');
  extremes.innerHTML = '';
  if (S.longest) extremes.innerHTML += `<li>Longest: ${S.longest.title} — ${S.longest.pages} pages (${S.longest.author})</li>`;
  if (S.shortest) extremes.innerHTML += `<li>Shortest: ${S.shortest.title} — ${S.shortest.pages} pages (${S.shortest.author})</li>`;
}

/* ========= Toggle between list and stats (REVISED) ========= */
(function(){
  const statsEl = document.getElementById('stats');
  const contentEl = document.getElementById('content');
  const statsToggleBtn = document.getElementById('statsToggle');
  let built = false;

  statsToggleBtn?.addEventListener('click', async ()=>{
    const showingStats = !statsEl.hasAttribute('hidden');

    if (showingStats){
      // Action: Hide stats, show the book list
      statsEl.setAttribute('hidden','');
      contentEl.removeAttribute('hidden');
      statsToggleBtn.innerHTML = '📈 Stats';
      statsToggleBtn.title = 'Show stats';
      window.scrollTo({top:0, behavior:'smooth'});
    } else {
      // Action: Show stats, hide the book list
      contentEl.setAttribute('hidden','');
      statsEl.removeAttribute('hidden');
      statsToggleBtn.innerHTML = '📚 Book list';
      statsToggleBtn.title = 'Show book list';

      if (!built){
        built = true;
        try {
          // Wait for the next browser frame. This is crucial to ensure that
          // the #stats section is visible and its canvas elements have dimensions
          // before we attempt to draw on them.
          await new Promise(resolve => requestAnimationFrame(resolve));
          await buildStats();
        } catch (error) {
          console.error("Failed to build stats:", error);
          statsEl.querySelector('.stats-grid').innerHTML = '<p class="sub" style="grid-column: 1 / -1; text-align:center;">Could not load statistics.</p>';
        }
      }
      statsEl.scrollIntoView({ behavior: 'smooth' });
    }
  });
})();
</script>

</body>
</html>
